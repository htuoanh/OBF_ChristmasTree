<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ„ Gemeinsam dekorieren â€“ 3Dâ€‘Weihnachtsbaum</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .app { display: grid; grid-template-columns: 320px 1fr; height: 100%; }
    .panel { background: #0f172a; color: #e5e7eb; padding: 16px; overflow: auto; }
    .panel h1 { font-size: 18px; margin: 0 0 8px; }
    .panel .muted { color: #94a3b8; font-size: 12px; }
    .controls { display: grid; gap: 12px; margin-top: 12px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 12px; }
    label { display: block; font-size: 12px; color: #9ca3af; margin-bottom: 6px; }
    input[type="text"], input[type="file"], input[type="color"], select, button { width: 100%; }
    button { background: #22c55e; color: #0b0f19; border: none; border-radius: 10px; padding: 10px 12px; font-weight: 600; cursor: pointer; }
    button.secondary { background: #334155; color: #e5e7eb; }
    button.destructive { background: #ef4444; color: white; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .list { display: grid; gap: 8px; }
    .list-item { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; background: #0b1220; border: 1px solid #1f2937; border-radius: 10px; padding: 8px; }
    .list-item small { color: #9ca3af; }
    .hint { font-size: 11px; color: #9ca3af; }
    .canvas-wrap { position: relative; }
    canvas { display: block; width: 100%; height: 100%; background: #0b0f19; }
    .toast { position: absolute; left: 50%; top: 16px; transform: translateX(-50%); background: rgba(17,24,39,.9); color: #e5e7eb; padding: 8px 12px; border-radius: 12px; border: 1px solid #1f2937; font-size: 12px; }
    .linkbox { display:flex; gap:8px; align-items:center; background:#0b1220; border:1px solid #1f2937; padding:8px; border-radius:10px; }
    .linkbox code { color:#e5e7eb; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body>
<div class="app">
  <aside class="panel">
    <h1>ğŸ„ 3Dâ€‘Weihnachtsbaum</h1>
    <div class="muted">Gemeinsam schmÃ¼cken â€“ einfach diesen Link teilen. Jeder mit dem Link kann Ornamente hinzufÃ¼gen. Nutzer dÃ¼rfen <b>nur ihre eigenen</b> Ornamente lÃ¶schen.</div>

    <div class="card controls">
      <div class="row">
        <div>
          <label>Raumâ€‘ID (aus URL)</label>
          <input id="roomId" type="text" readonly />
        </div>
        <div>
          <label>Mein Nutzer</label>
          <input id="userId" type="text" readonly />
        </div>
      </div>
      <div>
        <label>Teilen</label>
        <div class="linkbox"><code id="shareLink"></code><button id="copyBtn" class="secondary" title="Kopieren">Kopieren</button></div>
        <div class="hint">Tipp: Nutzt denselben Link, um im gleichen Raum zu schmÃ¼cken.</div>
      </div>
    </div>

    <div class="card controls">
      <h2 style="margin:0;font-size:14px">Neues Ornament</h2>
      <div class="row">
        <div>
          <label>Farbe</label>
          <input id="colorPicker" type="color" value="#ff3b3b" />
        </div>
        <div>
          <label>GrÃ¶ÃŸe</label>
          <select id="size">
            <option value="0.12">Klein</option>
            <option value="0.18" selected>Mittel</option>
            <option value="0.24">GroÃŸ</option>
          </select>
        </div>
      </div>
      <button id="addColorBtn">Farbkugel hinzufÃ¼gen</button>
      <div>
        <label>Oder Bild hochladen (wird als Kugelâ€‘Textur verwendet)</label>
        <input id="fileInput" type="file" accept="image/*" />
      </div>
      <button id="addImageBtn" class="secondary">Bildâ€‘Ornament hinzufÃ¼gen</button>
      <div class="hint">Bild wird in Firebase Storage hochgeladen und nur von dir lÃ¶schbar.</div>
    </div>

    <div class="card">
      <h2 style="margin:0;font-size:14px">Meine Ornamente</h2>
      <div id="mine" class="list"></div>
    </div>

    <div class="card">
      <h2 style="margin:0;font-size:14px">Alle Ornamente im Raum</h2>
      <div id="all" class="list"></div>
    </div>

    <div class="card">
      <h2 style="margin:0;font-size:14px">Setup (einmalig)</h2>
      <ol class="hint">
        <li>Erstelle ein Firebaseâ€‘Projekt (Firestore + Storage aktivieren).</li>
        <li>Trage unten deine Firebaseâ€‘Konfiguration ein.</li>
        <li>Setze die Sicherheitsregeln aus dem Kommentar im Code (nur EigentÃ¼mer darf lÃ¶schen).</li>
        <li>Hoste die Datei z.â€¯B. bei Vercel/Netlify/GitHub Pages.</li>
        <li>Teile den Link. Raumâ€‘ID = URLâ€‘Hash (Alles nach <code>#</code>).</li>
      </ol>
    </div>
  </aside>

  <main class="canvas-wrap" id="canvasWrap">
    <div id="toast" class="toast" style="display:none"></div>
  </main>
</div>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158/examples/js/controls/OrbitControls.js"></script>

<!-- Firebase (Compat fÃ¼r einfache Nutzung im Browser) -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-storage-compat.js"></script>

<script>
// ======= ğŸ”§ Firebase konfigurieren (EINTRAGEN) =======
// 1) Ersetze die Platzhalter unten durch deine Firebase Webâ€‘Konfiguration.
// 2) Ã–ffne die Datei im Browser, die App initialisiert sich automatisch.
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
// ================================================

// ---- Util UI ----
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  clearTimeout(showToast._to);
  showToast._to = setTimeout(()=> t.style.display='none', 2200);
}

// ---- Raum / Link ----
function getOrCreateRoomId() {
  if (!location.hash) {
    const r = Math.random().toString(36).slice(2, 8);
    location.hash = r;
    return r;
  }
  return location.hash.replace('#','');
}
const roomId = getOrCreateRoomId();
const shareLink = location.origin + location.pathname + '#' + roomId;

// ---- Three.js Szene ----
let scene, camera, renderer, controls;
let tree, star, roomGroup;
const ornamentMeshes = new Map(); // docId -> Mesh

init3D();
function init3D() {
  const wrap = document.getElementById('canvasWrap');
  const w = wrap.clientWidth; const h = window.innerHeight;

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0f19);

  // Kamera
  camera = new THREE.PerspectiveCamera(60, w/h, 0.1, 100);
  camera.position.set(0.8, 1.6, 2.8);

  // Renderer
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(w, h);
  renderer.shadowMap.enabled = true;
  wrap.appendChild(renderer.domElement);

  // Controls
  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.target.set(0, 1.1, 0);

  // Licht
  const hemi = new THREE.HemisphereLight(0xffffff, 0x334155, 1.0);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 1.1);
  dir.position.set(2, 3, 2);
  dir.castShadow = true;
  scene.add(dir);

  // Boden / Wohnzimmerâ€‘Teppich
  const floorGeo = new THREE.PlaneGeometry(8, 8);
  const floorMat = new THREE.MeshStandardMaterial({ color: 0x1f2937 });
  const floor = new THREE.Mesh(floorGeo, floorMat);
  floor.rotation.x = -Math.PI/2; floor.position.y = 0;
  floor.receiveShadow = true; scene.add(floor);

  // WÃ¤nde minimalistisch
  roomGroup = new THREE.Group();
  const wallMat = new THREE.MeshStandardMaterial({ color: 0x0f172a, side: THREE.BackSide });
  const roomBox = new THREE.Mesh(new THREE.BoxGeometry(10, 4, 10), wallMat);
  roomBox.position.y = 2; roomBox.receiveShadow = true; roomGroup.add(roomBox);
  // Fensterâ€‘Lichter
  const point = new THREE.PointLight(0xfff1b8, 0.8, 10); point.position.set(-2,2, -1); roomGroup.add(point);
  scene.add(roomGroup);

  // Baum (Kegel + Stamm)
  const H = 2.2; const R = 1.0;
  const coneGeo = new THREE.ConeGeometry(R, H, 64, 16);
  const coneMat = new THREE.MeshStandardMaterial({ color: 0x0b8a2f, roughness: 0.9, metalness: 0.0 });
  tree = new THREE.Mesh(coneGeo, coneMat); tree.position.y = H/2 + 0.2; tree.castShadow = true; tree.receiveShadow = true; scene.add(tree);

  const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.18, 0.22, 0.4, 24), new THREE.MeshStandardMaterial({ color: 0x6b3f1d }));
  trunk.position.y = 0.2; trunk.castShadow = true; scene.add(trunk);

  // Stern
  star = new THREE.Mesh(new THREE.OctahedronGeometry(0.18, 0), new THREE.MeshStandardMaterial({ color: 0xffd54a, emissive: 0x443300 }));
  star.position.set(0, H + 0.4, 0); star.castShadow = true; scene.add(star);

  // Renderloop
  function animate() {
    requestAnimationFrame(animate);
    star.rotation.y += 0.01;
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', () => {
    const ww = wrap.clientWidth; const hh = window.innerHeight;
    camera.aspect = ww/hh; camera.updateProjectionMatrix();
    renderer.setSize(ww, hh);
  });
}

// Hilfsfunktion: zufÃ¤lliger Punkt auf der BaumoberflÃ¤che
function randomPositionOnTree() {
  const H = 2.2; const R = 1.0; // wie beim Kegel
  const h = Math.random() * (H * 0.9) + H*0.05; // nicht ganz unten/oben
  const r = (H - h) / H * R * 0.95;
  const theta = Math.random() * Math.PI * 2;
  const x = r * Math.cos(theta);
  const z = r * Math.sin(theta);
  const y = h + 0.2; // Baumposition berÃ¼cksichtigen
  return new THREE.Vector3(x, y, z);
}

function createOrnamentMesh({ color = 0xff0000, size = 0.18, textureURL = null }) {
  const geo = new THREE.SphereGeometry(size, 32, 32);
  const mat = textureURL ? new THREE.MeshStandardMaterial({ map: new THREE.TextureLoader().load(textureURL), metalness: 0.3, roughness: 0.4 })
                         : new THREE.MeshStandardMaterial({ color, metalness: 0.3, roughness: 0.4 });
  const mesh = new THREE.Mesh(geo, mat);
  mesh.castShadow = true;
  const p = randomPositionOnTree();
  mesh.position.copy(p);
  // kleine Kappe
  const cap = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.05, 12), new THREE.MeshStandardMaterial({ color: 0xcbd5e1 }));
  cap.position.set(0, size + 0.03, 0); cap.castShadow = true; mesh.add(cap);
  return mesh;
}

// ---- Firebase einrichten ----
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let currentUser = null;

async function ensureAuth() {
  const cred = await auth.signInAnonymously();
  currentUser = cred.user; // { uid }
  return currentUser;
}

// Firestore Referenzen
function roomCol() { return db.collection('rooms').doc(roomId).collection('ornaments'); }

// UI Elemente fÃ¼llen
const roomIdEl = document.getElementById('roomId');
const userIdEl = document.getElementById('userId');
const shareEl = document.getElementById('shareLink');
const copyBtn = document.getElementById('copyBtn');
roomIdEl.value = roomId; shareEl.textContent = shareLink; copyBtn.onclick = () => { navigator.clipboard.writeText(shareLink); showToast('Link kopiert!'); };

// Start
ensureAuth().then(() => {
  userIdEl.value = currentUser.uid.slice(0,6) + 'â€¦';
  subscribeToOrnaments();
}).catch(e => { console.error(e); alert('Auth fehlgeschlagen. Konfiguration korrekt?'); });

// Liveâ€‘Sync
function subscribeToOrnaments() {
  roomCol().orderBy('createdAt', 'asc').onSnapshot((snap) => {
    const mineList = document.getElementById('mine');
    const allList = document.getElementById('all');
    mineList.innerHTML = ''; allList.innerHTML = '';

    const seen = new Set();

    snap.docChanges().forEach(change => {
      const doc = change.doc; const data = doc.data();
      if (change.type === 'removed') {
        // Mesh entfernen
        const mesh = ornamentMeshes.get(doc.id);
        if (mesh) { scene.remove(mesh); ornamentMeshes.delete(doc.id); }
        return;
      }
      // hinzugefÃ¼gt/geÃ¤ndert
      if (!ornamentMeshes.has(doc.id)) {
        const mesh = createOrnamentMesh({ color: data.color || 0xff0000, size: data.size || 0.18, textureURL: data.textureURL || null });
        if (data.position) mesh.position.set(data.position.x, data.position.y, data.position.z);
        scene.add(mesh); ornamentMeshes.set(doc.id, mesh);
      }
    });

    // Listen neu aufbauen
    snap.forEach(d => {
      const data = d.data();
      const isMine = data.userId === (currentUser && currentUser.uid);

      const liAll = document.createElement('div');
      liAll.className = 'list-item';
      liAll.innerHTML = `<div>${data.textureURL ? 'ğŸ–¼ï¸ Bildâ€‘' : 'ğŸ”´ Farbâ€‘'}Ornament Â· <small>${(data.size||0.18).toFixed(2)} Â· ${isMine ? 'deins' : 'von jemandem'}</small></div>`;
      const noop = document.createElement('div'); liAll.appendChild(noop); allList.appendChild(liAll);

      if (isMine) {
        const liMine = document.createElement('div');
        liMine.className = 'list-item';
        const label = data.textureURL ? 'Bildâ€‘Ornament' : 'Farbâ€‘Ornament';
        liMine.innerHTML = `<div>${label}<br/><small>${d.id.slice(0,6)}â€¦</small></div>`;
        const btn = document.createElement('button'); btn.className = 'destructive'; btn.textContent = 'LÃ¶schen';
        btn.onclick = () => deleteOrnament(d.id, data);
        liMine.appendChild(btn);
        mineList.appendChild(liMine);
      }
    });
  });
}

// Ornament anlegen (Farbe)
async function addColorOrnament() {
  const colorHex = document.getElementById('colorPicker').value; // z. B. #ff0000
  const size = parseFloat(document.getElementById('size').value);
  const pos = randomPositionOnTree();
  await roomCol().add({
    userId: currentUser.uid,
    type: 'color',
    color: parseInt(colorHex.replace('#','0x')),
    size,
    position: { x: pos.x, y: pos.y, z: pos.z },
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  showToast('Ornament hinzugefÃ¼gt');
}

// Ornament anlegen (Bild)
async function addImageOrnament(file) {
  if (!file) { alert('Bitte ein Bild wÃ¤hlen.'); return; }
  const size = parseFloat(document.getElementById('size').value);
  const ext = file.name.split('.').pop();
  const path = `rooms/${roomId}/uploads/${currentUser.uid}/${Date.now()}.${ext}`;
  const ref = storage.ref().child(path);
  await ref.put(file, { contentType: file.type });
  const url = await ref.getDownloadURL();
  const pos = randomPositionOnTree();
  await roomCol().add({
    userId: currentUser.uid,
    type: 'image',
    textureURL: url,
    storagePath: path,
    size,
    position: { x: pos.x, y: pos.y, z: pos.z },
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  showToast('Bildâ€‘Ornament hinzugefÃ¼gt');
}

// Eigenes Ornament lÃ¶schen
async function deleteOrnament(id, data) {
  try {
    // Firestore lÃ¶schen â€“ Sicherheitsregeln prÃ¼fen EigentÃ¼mer
    await roomCol().doc(id).delete();
    // Falls Bild, auch Storage versuchen (Regeln erlauben nur EigentÃ¼mer)
    if (data.storagePath) {
      await storage.ref().child(data.storagePath).delete().catch(()=>{});
    }
    showToast('GelÃ¶scht');
  } catch (e) {
    console.error(e);
    alert('LÃ¶schen nicht erlaubt (nur eigene Ornamente) oder Konfiguration prÃ¼fen.');
  }
}

// Buttons
document.getElementById('addColorBtn').onclick = addColorOrnament;

document.getElementById('addImageBtn').onclick = async () => {
  const f = document.getElementById('fileInput').files[0];
  await addImageOrnament(f);
};

// Inputs fÃ¼llen
shareEl.textContent = shareLink;

// Formularfelder initialisieren
(function initUI(){
  document.getElementById('roomId').value = roomId;
})();
</script>

<!--
ğŸ“œ Firebase Sicherheitsregeln (Beispiel)

// Firestore (nur EigentÃ¼mer darf sein Dokument lÃ¶schen, jeder darf lesen & eigene schreiben)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /rooms/{roomId}/ornaments/{ornamentId} {
      allow read: if true; // Ã¶ffentlich lesbar fÃ¼r Linkâ€‘Besitzer
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if false; // optional: keine Updates (nur lÃ¶schen/neu anlegen)
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}

// Storage (nur EigentÃ¼mer darf eigene Uploads verwalten)
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /rooms/{roomId}/uploads/{uid}/{fileName} {
      allow read: if true; // Vorschaubilder
      allow write: if request.auth != null && request.auth.uid == uid;
      allow delete: if request.auth != null && request.auth.uid == uid;
    }
  }
}

ğŸ’¡ Hinweise
- Zugriff via Link: Die Raumâ€‘ID steckt im URLâ€‘Hash (#abc123). Wer den Link hat, landet im selben Firestoreâ€‘â€Raumâ€œ.
- Anonyme Authentifizierung reicht: Aktivieren in Firebase Authentication > Signâ€‘in method > Anonymous.
- Missbrauchsschutz: Optional Cloud Function, die alte Ornamente nach X Tagen entfernt; oder reCAPTCHA Enterprise.
- DSGVO: Weist die Nutzer auf Bildâ€‘Uploads hin (Ã¶ffentliche Sichtbarkeit fÃ¼r Linkâ€‘Besitzer); ggf. Contentâ€‘Moderation ergÃ¤nzen.
-->

</body>
</html>
